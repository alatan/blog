---  
title: "SpringCloud总结"
description: "SpringCloud总结"
keywords: ["Spring"]
date: 2020-04-02
author: "默哥"
weight: 70
draft: false

categories: ["Spring"]
tags: ["Spring", "大纲"]  
toc: 
    auto: false
---
* Spring 以 Bean（对象） 为中心，提供 IOC、AOP 等功能。
* Spring Boot 以 Application（应用） 为中心，提供自动配置、监控等功能。
* Spring Cloud 以 Service（服务） 为中心，提供服务的注册与发现、服务的调用与负载均衡等功能。

![](/images/spring/springcloud/springcloud.jpg "Spring Cloud")

Spring Cloud是一系列框架的有序集合。它利用Spring Boot的开发便利性巧妙地简化了分布式系统基础设施的开发，如服务发现注册、配置中心、消息总线、负载均衡、熔断保护、数据监控等，都可以用Spring Boot的开发风格做到一键启动和部署。Spring Cloud并没有重复制造轮子，它只是将各家公司开发的比较成熟、经得起实际考验的服务框架组合起来，通过Spring Boot风格进行再封装屏蔽掉了复杂的配置和实现原理，最终给开发者留出了一套简单易懂、易部署和易维护的分布式系统开发工具包。

### 版本对应
| Spring Cloud Version  | 	Spring Boot Version | 	Spring Cloud Alibaba Version | 
| :---   | :--- | :---  |
| Spring Cloud 2020.0.1  | 	2.4.x | 	2021.1 |
| Spring Cloud Hoxton 	 | 2.2.x, 2.3.x   |	2.2.x |
| Spring Cloud Greenwich |	2.1.x  |	2.1.x |
| Spring Cloud Finchley  |	2.0.x  |	2.0.x(停止维护，建议升级) |
| Spring Cloud Edgware   |	1.5.x  |	1.5.x(停止维护，建议升级) |
| Spring Cloud Dalston   |	1.5.x  |	1.5.x(停止维护，建议升级) |

## SpringCloud的基础功能
* 服务治理： Spring  Cloud Eureka
* 客户端负载均衡： Spring Cloud Ribbon
* 服务容错保护： Spring  Cloud Hystrix  
* 声明式服务调用： Spring  Cloud Feign
* API网关服务：Spring Cloud Zuul
* 分布式配置中心： Spring Cloud Config

## 服务治理-Eureka
> 为了解决微服务架构中的服务实例维护问题(ip地址)， 产生了大量的服务治理框架和产品。 这些框架和产品的实现都围绕着服务注册与服务发现机制来完成对微服务应用实例的自动化管理。

* 服务提供者
    * 服务注册：启动的时候会通过发送REST请求的方式将自己注册到Eureka Server上，同时带上了自身服务的一些元数据信息。
    * 服务续约：在注册完服务之后，服务提供者会维护一个心跳用来持续告诉Eureka Server:  "我还活着 ” 、
    * 服务下线：当服务实例进行正常的关闭操作时，它会触发一个服务下线的REST请求给Eureka Server, 告诉服务注册中心：“我要下线了 ”。

* 服务消费者
    * 获取服务：当我们启动服务消费者的时候，它会发送一个REST请求给服务注册中心，来获取上面注册的服务清单
    * 服务调用：服务消费者在获取服务清单后，通过服务名可以获得具体提供服务的实例名和该实例的元数据信息。在进行服务调用的时候，优先访问同处一个Zone中的服务提供方。

* Eureka Server(服务注册中心)：
    * 失效剔除：默认每隔一段时间（默认为60秒） 将当前清单中超时（默认为90秒）没有续约的服务剔除出去。
    * 自我保护：。EurekaServer 在运行期间，会统计心跳失败的比例在15分钟之内是否低于85%(通常由于网络不稳定导致)。 Eureka Server会将当前的实例注册信息保护起来， 让这些实例不会过期，尽可能保护这些注册信息。

## 熔断 和 降级
> 在分布式环境中，不可避免地会有许多服务依赖项中的某些失败。Hystrix是一个库，可通过添加等待时间容限和容错逻辑来帮助您控制这些分布式服务之间的交互。Hystrix通过隔离服务之间的访问点，停止服务之间的级联故障并提供后备选项来实现此目的，所有这些都可以提高系统的整体弹性。

### 熔断 
是服务雪崩的一种有效解决方案。当指定时间窗内的请求失败率达到设定阈值时，系统将通过 断路器 直接将此请求链路断开。

## 服务网关
1. 反向代理
* 这个是所有网关，包括nginx的基本功能。除了能够对服务进行整形，网关一个非常重要的附加收益，就是对后端的服务细节进行了屏蔽。
* 反向代理同时会带有负载均衡的功能，包括带权重的流量分配。

2. 鉴权
* 就是权限认证，也就是常说的权限系统。由于鉴权服务有非常高的相似性，就可以进行抽象处理，放在网关层。
* 比如https协议的统一接入，分布式session的处理问题，新的登录鉴权通道的接入等。

3. 流量控制
* 流量控制如果分散到每个服务里去做，就是一种灾难，网关是最适合的地方。
* 流量控制通常有多种策略，对后端服务进行屏蔽。非正常请求和超出负载能力的请求，都会被快速拦截在外，为系统的稳定性提供了必不可少的支持。
* 流量控制有单机限流和分布式限流两种方式，后者控制更加精细一些，spring cloud gateway都有提供。

4. 熔断
* 熔断与流控的主要区别，在于前者在一段时间内，服务“不可用”，而后者仅概率性失败。
* 除了服务之间的调用涉及到熔断，在网关层的熔断，作用范围会更大，需要对服务进行准确的分级。

5. 灰度控制
* 网关的一个终极功能，就是实现服务的灰度发布。比如常说的AB test，就是一种灰度发布方式。
* 灰度会进行精细化控制，比如针对一类用户，某个物理区域，特定请求路径，特定模块，随机百分比等方面的一些灰度控制等。
* 灰度是一个整体架构配合的结果，但协调的入口就是网关，通过对请求头或者参数加入一些特定的标志，就可以对每个请求进行划分，决定是否落入灰度。

6. 日志监控
* 网关是最适合进行日志监控的地方。通过对访问日志的精细分析，能够得到很多有价值的数据，进而对后端服务的优化提供决策依据。
* 比如，某个“业务”的访问趋势，运营数据，QPS峰值，同比、环比等。