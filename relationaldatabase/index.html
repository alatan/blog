<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>关系型数据库概览 - 追求卓越，幸福就会不期而遇</title><meta name="Description" content="关系型数据库概览"><meta property="og:title" content="关系型数据库概览" />
<meta property="og:description" content="关系型数据库概览" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://moge.fun/relationaldatabase/" />
<meta property="og:image" content="https://moge.fun/logo.png"/>
<meta property="article:published_time" content="2017-03-01T00:00:00+00:00" />
<meta property="article:modified_time" content="2017-03-01T00:00:00+00:00" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://moge.fun/logo.png"/>

<meta name="twitter:title" content="关系型数据库概览"/>
<meta name="twitter:description" content="关系型数据库概览"/>
<meta name="application-name" content="Journey to the Life">
<meta name="apple-mobile-web-app-title" content="Journey to the Life"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://moge.fun/relationaldatabase/" /><link rel="prev" href="https://moge.fun/algorithm/" /><link rel="next" href="https://moge.fun/mysql/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "关系型数据库概览",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/moge.fun\/relationaldatabase\/"
        },"genre": "posts","keywords": "数据库, 大纲","wordcount":  499 ,
        "url": "https:\/\/moge.fun\/relationaldatabase\/","datePublished": "2017-03-01T00:00:00+00:00","dateModified": "2017-03-01T00:00:00+00:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "默哥"
            },"description": "关系型数据库概览"
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="追求卓越，幸福就会不期而遇">追求卓越，幸福就会不期而遇</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 所有文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/about/"> 关于 </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="追求卓越，幸福就会不期而遇">追求卓越，幸福就会不期而遇</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title="">所有文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/about/" title="">关于</a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content always-active" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">关系型数据库概览</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>默哥</a></span>&nbsp;<span class="post-category">收录于 <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"><i class="far fa-folder fa-fw"></i>数据库</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2017-03-01">2017-03-01</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 499 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 3 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#数据库组件">数据库组件</a>
      <ul>
        <li><a href="#核心组件">核心组件</a></li>
        <li><a href="#工具">工具</a></li>
        <li><a href="#查询管理器">查询管理器</a></li>
        <li><a href="#数据管理器">数据管理器：</a></li>
      </ul>
    </li>
    <li><a href="#数据查询的流程">数据查询的流程</a>
      <ul>
        <li><a href="#客户端管理器">客户端管理器</a></li>
        <li><a href="#查询管理器-1">查询管理器</a></li>
        <li><a href="#数据管理器-1">数据管理器</a>
          <ul>
            <li><a href="#缓冲区">缓冲区</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#核心知识点">核心知识点</a>
      <ul>
        <li><a href="#事务">事务</a>
          <ul>
            <li><a href="#acid特性">ACID特性</a>
              <ul>
                <li><a href="#原子性atomicity">原子性(Atomicity)</a></li>
                <li><a href="#一致性consistency">一致性(Consistency)</a></li>
                <li><a href="#隔离性isolation">隔离性(Isolation)</a></li>
                <li><a href="#持久性durability">持久性(Durability)</a></li>
              </ul>
            </li>
            <li><a href="#acid特性的相互关系">ACID特性的相互关系</a></li>
          </ul>
        </li>
        <li><a href="#并发一致性问题">并发一致性问题</a>
          <ul>
            <li><a href="#丢失修改">丢失修改</a></li>
            <li><a href="#读脏数据">读脏数据</a></li>
            <li><a href="#不可重复读">不可重复读</a></li>
            <li><a href="#幻影读">幻影读</a></li>
          </ul>
        </li>
        <li><a href="#并发一致性的解决方案">并发一致性的解决方案</a></li>
        <li><a href="#隔离级别">隔离级别</a>
          <ul>
            <li><a href="#未提交读read-uncommitted">未提交读(READ UNCOMMITTED)</a></li>
            <li><a href="#提交读read-committed">提交读(READ COMMITTED)</a></li>
            <li><a href="#可重复读repeatable-read">可重复读(REPEATABLE READ)</a></li>
            <li><a href="#可串行化serializable">可串行化(SERIALIZABLE)</a></li>
          </ul>
        </li>
        <li><a href="#封锁">封锁</a>
          <ul>
            <li><a href="#封锁粒度">封锁粒度</a></li>
            <li><a href="#封锁类型">封锁类型</a>
              <ul>
                <li><a href="#读写锁">读写锁</a></li>
                <li><a href="#意向锁">意向锁</a></li>
              </ul>
            </li>
            <li><a href="#封锁协议">封锁协议</a>
              <ul>
                <li><a href="#三级封锁协议">三级封锁协议</a>
                  <ul>
                    <li><a href="#一级封锁协议">一级封锁协议</a></li>
                    <li><a href="#二级封锁协议">二级封锁协议</a></li>
                    <li><a href="#三级封锁协议-1">三级封锁协议</a></li>
                  </ul>
                </li>
                <li><a href="#两段锁协议">两段锁协议</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#多版本并发控制">多版本并发控制</a>
          <ul>
            <li><a href="#版本号">版本号</a></li>
            <li><a href="#隐藏的列">隐藏的列</a></li>
            <li><a href="#undo-日志">Undo 日志</a></li>
            <li><a href="#实现过程">实现过程</a></li>
            <li><a href="#快照读与当前读">快照读与当前读</a>
              <ul>
                <li><a href="#快照读">快照读</a></li>
                <li><a href="#当前读">当前读</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#next-key-locks">Next-Key Locks</a>
          <ul>
            <li><a href="#record-locks行锁">Record Locks（行锁）</a></li>
            <li><a href="#gap-locks间隙锁">Gap Locks（间隙锁）</a></li>
            <li><a href="#next-key-locks-1">Next-Key Locks</a></li>
          </ul>
        </li>
        <li><a href="#锁行锁表">锁行锁表</a></li>
      </ul>
    </li>
    <li><a href="#参考文章">参考文章</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p><figure><a class="lightgallery" href="/images/db/db.png" title="/images/db/db.png" data-thumbnail="/images/db/db.png" data-sub-html="<h2>数据库总览</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/db/db.png"
            data-srcset="/images/db/db.png, /images/db/db.png 1.5x, /images/db/db.png 2x"
            data-sizes="auto"
            alt="/images/db/db.png" />
    </a><figcaption class="image-caption">数据库总览</figcaption>
    </figure></p>
<p><figure><a class="lightgallery" href="/images/db/rdb/sqlDB.png" title="/images/db/rdb/sqlDB.png" data-thumbnail="/images/db/rdb/sqlDB.png" data-sub-html="<h2>SQL数据库原理</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/db/rdb/sqlDB.png"
            data-srcset="/images/db/rdb/sqlDB.png, /images/db/rdb/sqlDB.png 1.5x, /images/db/rdb/sqlDB.png 2x"
            data-sizes="auto"
            alt="/images/db/rdb/sqlDB.png" />
    </a><figcaption class="image-caption">SQL数据库原理</figcaption>
    </figure></p>
<h2 id="数据库组件">数据库组件</h2>
<p><figure><a class="lightgallery" href="/images/db/rdb/allComponent.png" title="/images/db/rdb/allComponent.png" data-thumbnail="/images/db/rdb/allComponent.png" data-sub-html="<h2>SQL数据库概览</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/db/rdb/allComponent.png"
            data-srcset="/images/db/rdb/allComponent.png, /images/db/rdb/allComponent.png 1.5x, /images/db/rdb/allComponent.png 2x"
            data-sizes="auto"
            alt="/images/db/rdb/allComponent.png" />
    </a><figcaption class="image-caption">SQL数据库概览</figcaption>
    </figure></p>
<h3 id="核心组件">核心组件</h3>
<ul>
<li>进程管理器（process manager）：很多数据库具备一个需要妥善管理的进程/线程池。再者，为了实现纳秒级操作，一些现代数据库使用自己的线程而不是操作系统线程。</li>
<li>网络管理器（network manager）：网路I/O是个大问题，尤其是对于分布式数据库。所以一些数据库具备自己的网络管理器。</li>
<li>文件系统管理器（File system manager）：磁盘I/O是数据库的首要瓶颈。具备一个文件系统管理器来完美地处理OS文件系统甚至取代OS文件系统，是非常重要的。</li>
<li>内存管理器（memory manager）：为了避免磁盘I/O带来的性能损失，需要大量的内存。但是如果你要处理大容量内存你需要高效的内存管理器，尤其是你有很多查询同时使用内存的时候。</li>
<li>安全管理器（Security Manager）：用于对用户的验证和授权。</li>
<li>客户端管理器（Client manager）：用于管理客户端连接。</li>
</ul>
<h3 id="工具">工具</h3>
<ul>
<li>备份管理器（Backup manager）：用于保存和恢复数据。</li>
<li>恢复管理器（Recovery manager）：用于崩溃后重启数据库到一个一致状态。</li>
<li>监控管理器（Monitor manager）：用于记录数据库活动信息和提供监控数据库的工具。</li>
<li>管理员管理器（Administration manager）：用于保存元数据（比如表的名称和结构），提供管理数据库、模式、表空间的工具。</li>
</ul>
<h3 id="查询管理器">查询管理器</h3>
<ul>
<li>查询解析器（Query parser）：用于检查查询是否合法</li>
<li>查询重写器（Query rewriter）：用于预优化查询</li>
<li>查询优化器（Query optimizer）：用于优化查询</li>
<li>查询执行器（Query executor）：用于编译和执行查询</li>
</ul>
<h3 id="数据管理器">数据管理器：</h3>
<ul>
<li>事务管理器（Transaction manager）：用于处理事务</li>
<li>缓存管理器（Cache manager）：数据被使用之前置于内存，或者数据写入磁盘之前置于内存</li>
<li>数据访问管理器（Data access manager）：访问磁盘中的数据</li>
</ul>
<h2 id="数据查询的流程">数据查询的流程</h2>
<p>本章集中探讨数据库如何通过如下进程管理SQL查询的：</p>
<ol>
<li>客户端管理器</li>
<li>查询管理器</li>
<li>数据管理器（含恢复管理器）</li>
<li>客户端管理器</li>
</ol>
<h3 id="客户端管理器">客户端管理器</h3>
<blockquote>
<p>客户端管理器是处理客户端通信的。客户端可以是一个（网站）服务器或者一个最终用户或最终应用。客户端管理器通过一系列知名的API（JDBC, ODBC, OLE-DB …）提供不同的方式来访问数据库。客户端管理器也提供专有的数据库访问API。</p>
</blockquote>
<p><figure><a class="lightgallery" href="/images/db/rdb/ClientManager.png" title="/images/db/rdb/ClientManager.png" data-thumbnail="/images/db/rdb/ClientManager.png" data-sub-html="<h2>客户端管理器</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/db/rdb/ClientManager.png"
            data-srcset="/images/db/rdb/ClientManager.png, /images/db/rdb/ClientManager.png 1.5x, /images/db/rdb/ClientManager.png 2x"
            data-sizes="auto"
            alt="/images/db/rdb/ClientManager.png" />
    </a><figcaption class="image-caption">客户端管理器</figcaption>
    </figure>
当你连接到数据库时：</p>
<ul>
<li>管理器首先检查你的验证信息（用户名和密码），然后检查你是否有访问数据库的授权。这些权限由DBA分配。</li>
<li>然后，管理器检查是否有空闲进程（或线程）来处理你对查询。</li>
<li>管理器还会检查数据库是否负载很重。</li>
<li>管理器可能会等待一会儿来获取需要的资源。如果等待时间达到超时时间，它会关闭连接并给出一个可读的错误信息。</li>
<li>然后管理器会把你的查询送给查询管理器来处理。</li>
<li>因为查询处理进程不是『不全则无』的，一旦它从查询管理器得到数据，它会把部分结果保存到一个缓冲区并且开始给你发送。</li>
<li>如果遇到问题，管理器关闭连接，向你发送可读的解释信息，然后释放资源。</li>
</ul>
<h3 id="查询管理器-1">查询管理器</h3>
<p><figure><a class="lightgallery" href="/images/db/rdb/QueryManager.png" title="/images/db/rdb/QueryManager.png" data-thumbnail="/images/db/rdb/QueryManager.png" data-sub-html="<h2>查询管理器</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/db/rdb/QueryManager.png"
            data-srcset="/images/db/rdb/QueryManager.png, /images/db/rdb/QueryManager.png 1.5x, /images/db/rdb/QueryManager.png 2x"
            data-sizes="auto"
            alt="/images/db/rdb/QueryManager.png" />
    </a><figcaption class="image-caption">查询管理器</figcaption>
    </figure>
这个多步骤操作过程如下：</p>
<ul>
<li>查询首先被解析并判断是否合法</li>
<li>然后被重写，去除了无用的操作并且加入预优化部分</li>
<li>接着被优化以便提升性能，并被转换为可执行代码和数据访问计划。</li>
<li>然后计划被编译</li>
<li>最后，被执行</li>
</ul>
<h3 id="数据管理器-1">数据管理器</h3>
<p><figure><a class="lightgallery" href="/images/db/rdb/DataManager.png" title="/images/db/rdb/DataManager.png" data-thumbnail="/images/db/rdb/DataManager.png" data-sub-html="<h2>查询管理器</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/db/rdb/DataManager.png"
            data-srcset="/images/db/rdb/DataManager.png, /images/db/rdb/DataManager.png 1.5x, /images/db/rdb/DataManager.png 2x"
            data-sizes="auto"
            alt="/images/db/rdb/DataManager.png" />
    </a><figcaption class="image-caption">查询管理器</figcaption>
    </figure>
在这一步，查询管理器执行了查询，需要从表和索引获取数据，于是向数据管理器提出请求。
但是有 2 个问题：</p>
<ul>
<li>关系型数据库使用事务模型，所以，当其他人在同一时刻使用或修改数据时，你无法得到这部分数据。</li>
<li>数据提取是数据库中速度最慢的操作，所以数据管理器需要足够聪明地获得数据并保存在内存缓冲区内。</li>
</ul>
<h4 id="缓冲区">缓冲区</h4>
<ul>
<li>缓冲池(buffer pool)是一种常见的降低磁盘访问的机制；</li>
<li>缓冲池通常以页(page)为单位缓存数据；</li>
<li>缓冲池的常见管理算法是LRU，memcache，OS，InnoDB都使用了这种算法；</li>
<li>InnoDB对普通LRU进行了优化：将缓冲池分为老生代和新生代，入缓冲池的页，优先进入老生代，页被访问，才进入新生代，以解决预读失效的问题页被访问，且在老生代停留时间超过配置阈值的，才进入新生代，以解决批量数据访问，大量热数据淘汰的问题</li>
</ul>
<h2 id="核心知识点">核心知识点</h2>
<h3 id="事务">事务</h3>
<blockquote>
<p>事务指的是满足 ACID 特性的一组操作，可以通过 Commit 提交一个事务，也可以使用 Rollback 进行回滚。</p>
</blockquote>
<h4 id="acid特性">ACID特性</h4>
<h5 id="原子性atomicity">原子性(Atomicity)</h5>
<p>事务被视为不可分割的最小单元，事务的所有操作要么全部提交成功，要么全部失败回滚。 回滚可以用日志来实现，日志记录着事务所执行的修改操作，在回滚时反向执行这些修改操作即可。</p>
<h5 id="一致性consistency">一致性(Consistency)</h5>
<p>数据库在事务执行前后都保持一致性状态。在一致性状态下，所有事务对一个数据的读取结果都是相同的。</p>
<h5 id="隔离性isolation">隔离性(Isolation)</h5>
<p>一个事务所做的修改在最终提交以前，对其它事务是不可见的。</p>
<h5 id="持久性durability">持久性(Durability)</h5>
<p>一旦事务提交，则其所做的修改将会永远保存到数据库中。即使系统发生崩溃，事务执行的结果也不能丢失。 可以通过数据库备份和恢复来实现，在系统发生崩溃时，使用备份的数据库进行数据恢复。</p>
<h4 id="acid特性的相互关系">ACID特性的相互关系</h4>
<p>事务的 ACID 特性概念简单，但不是很好理解，主要是因为这几个特性不是一种平级关系:</p>
<ul>
<li>只有满足一致性，事务的执行结果才是正确的。</li>
<li>在无并发的情况下，事务串行执行，隔离性一定能够满足。此时只要能满足原子性，就一定能满足一致性。</li>
<li>在并发的情况下，多个事务并行执行，事务不仅要满足原子性，还需要满足隔离性，才能满足一致性。</li>
<li>事务满足持久化是为了能应对数据库崩溃的情况。</li>
</ul>
<p><figure><a class="lightgallery" href="/images/db/rdb/dbc.png" title="/images/db/rdb/dbc.png" data-thumbnail="/images/db/rdb/dbc.png" data-sub-html="<h2>ACID</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/db/rdb/dbc.png"
            data-srcset="/images/db/rdb/dbc.png, /images/db/rdb/dbc.png 1.5x, /images/db/rdb/dbc.png 2x"
            data-sizes="auto"
            alt="/images/db/rdb/dbc.png" />
    </a><figcaption class="image-caption">ACID</figcaption>
    </figure></p>
<h3 id="并发一致性问题">并发一致性问题</h3>
<p>在并发环境下，<strong>事务的隔离性很难保证，因此会出现很多并发一致性问题。</strong></p>
<h4 id="丢失修改">丢失修改</h4>
<p>T1和T2两个事务都对一个数据进行修改，T1先修改，T2随后修改，<strong>T2的修改覆盖了T1的修改</strong>。</p>
<h4 id="读脏数据">读脏数据</h4>
<p>T1修改一个数据，T2随后读取这个数据。如果<strong>T1撤销了这次修改，那么T2读取的数据是脏数据。</strong></p>
<h4 id="不可重复读">不可重复读</h4>
<p><strong>T2读取一个数据，T1对该数据做了修改</strong>。如果T2再次读取这个数据，此时读取的结果和第一次读取的结果不同。</p>
<h4 id="幻影读">幻影读</h4>
<p><strong>T1读取某个范围的数据，T2在这个范围内插入新的数据，T1再次读取这个范围的数据</strong>，此时读取的结果和和第一次读取的结果不同。</p>
<h3 id="并发一致性的解决方案">并发一致性的解决方案</h3>
<p><strong>产生并发不一致性问题主要原因是破坏了事务的隔离性，解决方法是通过并发控制来保证隔离性</strong>。并发控制可以通过封锁来实现，但是<strong>封锁操作</strong>需要用户自己控制，相当复杂。</p>
<p><strong>数据库管理系统提供了事务的隔离级别，让用户以一种更轻松的方式处理并发一致性问题。</strong></p>
<h3 id="隔离级别">隔离级别</h3>
<blockquote>
<p>使用select @@tx_isolation;查询数据库的隔离级别。Mysql默认的级别是可重复读，优先考虑把数据库系统的隔离级别设为读已提交。</p>
</blockquote>
<h4 id="未提交读read-uncommitted">未提交读(READ UNCOMMITTED)</h4>
<p>读未提交，一个事务可以读到另一个事务未提交的数据！</p>
<h4 id="提交读read-committed">提交读(READ COMMITTED)</h4>
<p>读已提交，一个事务可以读到另一个事务已提交的数据!
一个事务只能读取已经提交的事务所做的修改。换句话说，一个事务所做的修改在提交之前对其它事务是不可见的。</p>
<h4 id="可重复读repeatable-read">可重复读(REPEATABLE READ)</h4>
<p>可重复读，加入间隙锁保证在同一个事务中多次读取同样数据的结果是一样的。</p>
<h4 id="可串行化serializable">可串行化(SERIALIZABLE)</h4>
<p>串行化，该级别下读写串行化，且所有的select语句后都自动加上lock in share mode，即使用了共享锁。因此在该隔离级别下，使用的是当前读，而不是快照读。</p>
<p><strong>多版本并发控制是MySQL的InnoDB存储引擎实现隔离级别的一种具体方式</strong>，用于实现<strong>提交读和可重复读这两种隔离级别</strong>。</p>
<p><strong>而未提交读隔离级别总是读取最新的数据行，无需使用 MVCC。可串行化隔离级别需要对所有读取的行都加锁，单纯使用 MVCC 无法实现。</strong></p>
<p>MySQL的InnoDB存储引擎<strong>采用两段锁协议，会根据隔离级别在需要的时候自动加锁，并且所有的锁都是在同一时刻被释放</strong>，这被称为隐式锁定。</p>
<p><figure><a class="lightgallery" href="/images/db/rdb/geli.png" title="/images/db/rdb/geli.png" data-thumbnail="/images/db/rdb/geli.png" data-sub-html="<h2>隔离级别</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/db/rdb/geli.png"
            data-srcset="/images/db/rdb/geli.png, /images/db/rdb/geli.png 1.5x, /images/db/rdb/geli.png 2x"
            data-sizes="auto"
            alt="/images/db/rdb/geli.png" />
    </a><figcaption class="image-caption">隔离级别</figcaption>
    </figure></p>
<h3 id="封锁">封锁</h3>
<h4 id="封锁粒度">封锁粒度</h4>
<p>MySQL 中提供了两种封锁粒度: 行级锁以及表级锁。
<figure><a class="lightgallery" href="/images/db/rdb/dblock.jpg" title="/images/db/rdb/dblock.jpg" data-thumbnail="/images/db/rdb/dblock.jpg" data-sub-html="<h2>封锁粒度</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/db/rdb/dblock.jpg"
            data-srcset="/images/db/rdb/dblock.jpg, /images/db/rdb/dblock.jpg 1.5x, /images/db/rdb/dblock.jpg 2x"
            data-sizes="auto"
            alt="/images/db/rdb/dblock.jpg" />
    </a><figcaption class="image-caption">封锁粒度</figcaption>
    </figure></p>
<h4 id="封锁类型">封锁类型</h4>
<h5 id="读写锁">读写锁</h5>
<ul>
<li>排它锁(Exclusive)，简写为 X 锁，又称写锁。</li>
<li>共享锁(Shared)，简写为 S 锁，又称读锁。</li>
</ul>
<p>有以下两个规定:</p>
<ul>
<li>一个事务对数据对象 A 加了 X 锁，就可以对 A 进行读取和更新。加锁期间其它事务不能对 A 加任何锁。</li>
<li>一个事务对数据对象 A 加了 S 锁，可以对 A 进行读取操作，但是不能进行更新操作。加锁期间其它事务能对 A 加 S 锁，但是不能加 X 锁。</li>
</ul>
<h5 id="意向锁">意向锁</h5>
<p>使用意向锁(Intention Locks)可以更容易地支持多粒度封锁。</p>
<p>在存在行级锁和表级锁的情况下，事务T想要对表A加X锁，就需要先检测是否有其它事务对表A或者表A中的任意一行加了锁，那么就需要<strong>对表A的每一行都检测一次，这是非常耗时的</strong>。</p>
<p>意向锁在原来的 X/S 锁之上引入了 IX/IS，IX/IS 都是表锁，用来表示一个事务想要在表中的某个数据行上加 X 锁或 S 锁。</p>
<ul>
<li>一个事务在获得某个数据行对象的 S 锁之前，必须先获得表的 IS 锁或者更强的锁；</li>
<li>一个事务在获得某个数据行对象的 X 锁之前，必须先获得表的 IX 锁。</li>
<li>任意 IS/IX 锁之间都是兼容的，因为它们只是表示想要对表加锁，而不是真正加锁；</li>
<li>S 锁只与 S 锁和 IS 锁兼容，也就是说事务 T 想要对数据行加 S 锁，其它事务可以已经获得对表或者表中的行的 S 锁。</li>
</ul>
<p><strong>通过引入意向锁，事务 T 想要对表 A 加 X 锁，只需要先检测是否有其它事务对表A加了 X/IX/S/IS 锁，如果加了就表示有其它事务正在使用这个表或者表中某一行的锁，因此事务T加X锁失败。</strong></p>
<h4 id="封锁协议">封锁协议</h4>
<h5 id="三级封锁协议">三级封锁协议</h5>
<h6 id="一级封锁协议">一级封锁协议</h6>
<p>事务 T 要修改数据 A 时必须加 X 锁，直到 T 结束才释放锁。</p>
<p>可以解决丢失修改问题，因为不能同时有两个事务对同一个数据进行修改，那么事务的修改就不会被覆盖。</p>
<h6 id="二级封锁协议">二级封锁协议</h6>
<p>在一级的基础上，要求读取数据 A 时必须加 S 锁，读取完马上释放 S 锁。</p>
<p>可以解决读脏数据问题，因为如果一个事务在对数据 A 进行修改，根据 1 级封锁协议，会加 X 锁，那么就不能再加 S 锁了，也就是不会读入数据。</p>
<h6 id="三级封锁协议-1">三级封锁协议</h6>
<p>在二级的基础上，要求读取数据 A 时必须加 S 锁，直到事务结束了才能释放 S 锁。</p>
<p>可以解决不可重复读的问题，因为读 A 时，其它事务不能对 A 加 X 锁，从而避免了在读的期间数据发生改变。</p>
<h5 id="两段锁协议">两段锁协议</h5>
<p>加锁和解锁分为两个阶段进行。</p>
<p>可串行化调度是指，通过并发控制，使得并发执行的事务结果与某个串行执行的事务结果相同。</p>
<p>事务遵循两段锁协议是保证可串行化调度的充分条件。例如以下操作满足两段锁协议，它是可串行化调度。</p>
<p>MySQL 的 InnoDB 存储引擎采用两段锁协议，会根据隔离级别在需要的时候自动加锁，并且所有的锁都是在同一时刻被释放，这被称为隐式锁定。</p>
<h3 id="多版本并发控制">多版本并发控制</h3>
<blockquote>
<p>多版本并发控制(Multi-Version Concurrency Control, MVCC)是 MySQL 的 InnoDB 存储引擎实现隔离级别的一种具体方式，用于实现提交读和可重复读这两种隔离级别。而未提交读隔离级别总是读取最新的数据行，无需使用 MVCC。可串行化隔离级别需要对所有读取的行都加锁，单纯使用 MVCC 无法实现。</p>
</blockquote>
<h4 id="版本号">版本号</h4>
<ul>
<li>系统版本号: 是一个递增的数字，每开始一个新的事务，系统版本号就会自动递增。</li>
<li>事务版本号: 事务开始时的系统版本号。</li>
</ul>
<h4 id="隐藏的列">隐藏的列</h4>
<p>MVCC 在每行记录后面都保存着两个隐藏的列，用来存储两个版本号:</p>
<ul>
<li>创建版本号: 指示创建一个数据行的快照时的系统版本号；</li>
<li>删除版本号: 如果该快照的删除版本号大于当前事务版本号表示该快照有效，否则表示该快照已经被删除了。</li>
</ul>
<h4 id="undo-日志">Undo 日志</h4>
<p>MVCC 使用到的快照存储在 Undo 日志中，该日志通过回滚指针把一个数据行(Record)的所有快照连接起来。</p>
<h4 id="实现过程">实现过程</h4>
<p>以下实现过程针对可重复读隔离级别。</p>
<p>当开始新一个事务时，该事务的版本号肯定会大于当前所有数据行快照的创建版本号，理解这一点很关键。</p>
<ol>
<li>SELECT</li>
</ol>
<blockquote>
<p>多个事务必须读取到同一个数据行的快照，并且这个快照是距离现在最近的一个有效快照。但是也有例外，如果有一个事务正在修改该数据行，那么它可以读取事务本身所做的修改，而不用和其它事务的读取结果一致。 把没有对一个数据行做修改的事务称为 T，T 所要读取的数据行快照的创建版本号必须小于 T 的版本号，因为如果大于或者等于 T 的版本号，那么表示该数据行快照是其它事务的最新修改，因此不能去读取它。除此之外，T 所要读取的数据行快照的删除版本号必须大于 T 的版本号，因为如果小于等于 T 的版本号，那么表示该数据行快照是已经被删除的，不应该去读取它。</p>
</blockquote>
<ol start="2">
<li>INSERT</li>
</ol>
<blockquote>
<p>将当前系统版本号作为数据行快照的创建版本号。</p>
</blockquote>
<ol start="3">
<li>DELETE</li>
</ol>
<blockquote>
<p>将当前系统版本号作为数据行快照的删除版本号。</p>
</blockquote>
<ol start="4">
<li>UPDATE</li>
</ol>
<blockquote>
<p>将当前系统版本号作为更新前的数据行快照的删除版本号，并将当前系统版本号作为更新后的数据行快照的创建版本号。可以理解为先执行 DELETE 后执行 INSERT。</p>
</blockquote>
<h4 id="快照读与当前读">快照读与当前读</h4>
<h5 id="快照读">快照读</h5>
<p>使用 MVCC 读取的是快照中的数据，这样可以减少加锁所带来的开销。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="k">table</span> <span class="p">...;</span>
</code></pre></td></tr></table>
</div>
</div><h5 id="当前读">当前读</h5>
<p>读取的是最新的数据，需要加锁。以下第一个语句需要加 S 锁，其它都需要加 X 锁。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="k">table</span> <span class="k">where</span> <span class="o">?</span> <span class="k">lock</span> <span class="k">in</span> <span class="k">share</span> <span class="k">mode</span><span class="p">;</span> <span class="o">//</span><span class="n">S锁</span> <span class="p">(</span><span class="err">共享锁</span><span class="p">)</span>
<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="k">table</span> <span class="k">where</span> <span class="o">?</span> <span class="k">for</span> <span class="k">update</span><span class="p">;</span>         <span class="o">//</span><span class="err">加</span><span class="n">X锁</span> <span class="p">(</span><span class="err">排他锁</span><span class="p">)</span>
<span class="k">insert</span><span class="p">;</span>
<span class="k">update</span><span class="p">;</span>
<span class="k">delete</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="next-key-locks">Next-Key Locks</h3>
<blockquote>
<p>Next-Key Locks 是 MySQL 的 InnoDB 存储引擎的一种锁实现。</p>
</blockquote>
<p>MVCC不能解决幻读的问题，Next-Key Locks 就是为了解决这个问题而存在的。<strong>在可重复读(REPEATABLE READ)隔离级别下，使用 MVCC + Next-Key Locks 可以解决幻读问题。</strong></p>
<h4 id="record-locks行锁">Record Locks（行锁）</h4>
<p>锁定一个记录上的索引，而不是记录本身。</p>
<p>该锁是对索引记录进行加锁！锁是在加索引上而不是行上的。注意了，innodb一定存在聚簇索引，因此行锁最终都会落到聚簇索引上！</p>
<p>如果表没有设置索引，InnoDB 会自动在主键上创建隐藏的聚簇索引，因此 Record Locks 依然可以使用。</p>
<h4 id="gap-locks间隙锁">Gap Locks（间隙锁）</h4>
<p>锁定索引之间的间隙，但是不包含索引本身。其目的只有一个，防止其他事物插入数据。</p>
<p>隔离级别比Read Committed低的情况下，不会使用间隙锁，如隔离级别为Read Uncommited时，也不存在间隙锁。当隔离级别为Repeatable Read和Serializable时，就会存在间隙锁。</p>
<p>例如当一个事务执行以下语句，其它事务就不能在 t.c 中插入 15。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="k">SELECT</span> <span class="k">c</span> <span class="k">FROM</span> <span class="n">t</span> <span class="k">WHERE</span> <span class="k">c</span> <span class="k">BETWEEN</span> <span class="mi">10</span> <span class="k">and</span> <span class="mi">20</span> <span class="k">FOR</span> <span class="k">UPDATE</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="next-key-locks-1">Next-Key Locks</h4>
<p>它是 Record Locks 和 Gap Locks 的结合，不仅锁定一个记录上的索引，也锁定索引之间的间隙。</p>
<p>例如一个索引包含以下值: 10, 11, 13, and 20，那么就需要锁定以下区间:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="p">(</span><span class="n">negative</span> <span class="n">infinity</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>
<span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">]</span>
<span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">13</span><span class="p">]</span>
<span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="mi">20</span><span class="p">]</span>
<span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="n">positive</span> <span class="n">infinity</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="锁行锁表">锁行锁表</h3>
<p>InnoDB行锁是通过给索引上的索引项加锁来实现，只有通过索引条件检索数据，InnoDB才使用行级锁，否则表锁（注意下面的解释）。</p>
<p>这里的表锁并不是用表锁来实现锁表的操作，而是利用了Next-Key Locks，也可以理解为是用了行锁+间隙锁来实现锁表的操作!</p>
<p>之所以能够锁表，是通过行锁+间隙锁来实现的。那么，RU和RC都不存在间隙锁，这种说法在RU和RC中还能成立么？ 因此，该说法只在RR和Serializable中是成立的。
<strong>如果隔离级别为RU和RC，无论条件列上是否有索引，都不会锁表，只锁行！</strong></p>
<h2 id="参考文章">参考文章</h2>
<ul>
<li><a href="https://www.pdai.tech/md/db/sql/sql-db-howitworks.html" title="关系型数据库是如何工作" target="_blank" rel="noopener noreffer">关系型数据库是如何工作的</a></li>
<li><a href="https://www.pdai.tech/md/db/sql/sql-db-theory.html" title="数据库系统核心知识点" target="_blank" rel="noopener noreffer">数据库系统核心知识点</a></li>
<li><a href="https://juejin.cn/post/6844903919387148296" title="select加锁分析" target="_blank" rel="noopener noreffer">select加锁分析</a></li>
<li><a href="https://www.pdai.tech/md/db/sql-mysql/sql-mysql-mvcc.html" title="MySQL InnoDB的MVCC实现机制" target="_blank" rel="noopener noreffer">MySQL InnoDB的MVCC实现机制</a></li>
<li><a href="https://www.pdai.tech/md/db/sql-mysql/sql-mysql-execute.html" title="一条SQL的执行过程详解" target="_blank" rel="noopener noreffer">一条SQL的执行过程详解</a></li>
</ul>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2017-03-01</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://moge.fun/relationaldatabase/" data-title="关系型数据库概览"><i class="fab fa-weibo fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a>,&nbsp;<a href="/tags/%E5%A4%A7%E7%BA%B2/">大纲</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/algorithm/" class="prev" rel="prev" title="算法概览"><i class="fas fa-angle-left fa-fw"></i>算法概览</a>
            <a href="/mysql/" class="next" rel="next" title="MySQL总结">MySQL总结<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id="comments"><div id="utterances"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://utteranc.es/">Utterances</a>.
            </noscript></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.69.1">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2015 - 2021</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">默哥</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/lightgallery/lightgallery.min.css"><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/katex/copy-tex.min.css"><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.stemmer.support.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.zh.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/lightgallery/lightgallery.min.js"></script><script type="text/javascript" src="/lib/lightgallery/lg-thumbnail.min.js"></script><script type="text/javascript" src="/lib/lightgallery/lg-zoom.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":10},"comment":{"utterances":{"darkTheme":"github-dark","issueTerm":"pathname","label":"","lightTheme":"github-light","repo":"alatan/BlogDiscuss"}},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","lunrLanguageCode":"zh","lunrSegmentitURL":"/lib/lunr/lunr.segmentit.js","maxResultLength":5,"noResultsFound":"没有找到结果","snippetLength":50,"type":"lunr"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
